name: Rust Cross Compile

on:
  workflow_dispatch:

jobs:

  build-linux:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Install Linux dependencies
      run: |
        rustup target add x86_64-unknown-linux-gnu
        sudo apt install gcc-multilib

    - name: Build for Linux
      run: cargo build --release --target x86_64-unknown-linux-gnu

  build-windows:

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2

    - name: Install Windows dependencies
      run: rustup target add x86_64-pc-windows-gnu

    - name: Build for Windows
      run: cargo build --release --target x86_64-pc-windows-gnu

  build-macos:

    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2

    - name: Install macOS dependencies
      run: rustup target add x86_64-apple-darwin

    - name: Build for macOS
      run: cargo build --release --target x86_64-apple-darwin

  release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        path: artifacts

    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*